import{a as W,g as Y}from"./index-BgX6ccBS.js";import{g as Z,d as $}from"./index-smoZw7E1.js";import{u as ee}from"./vue-router-DZ3MrWk1.js";import{T as ae}from"./TraceTopologyDiagram-7DbnLQIy.js";import{_ as le}from"./index-Dp-vnoFp.js";import{a as te,E as re}from"./element-plus-0z3gLYqD.js";import{r as m,X as S,b as ue,c as E,Q as a,I as l,ag as r,o as q,M as g,a as v,P as oe,a6 as ne,u as se,H as ie}from"./@vue-CnBZ4jx_.js";import"./axios-DW_MHI2K.js";import"./nprogress-Dx41icWA.js";import"./dayjs-B_aAqRSu.js";import"./arktourosUiConfigUtil-DM9bp1OR.js";import"./@vueuse-BrKJyrsM.js";import"./dateUtil-NlCD2qvi.js";import"./echarts-DuzIGl-8.js";import"./tslib-BDyQ-Jie.js";import"./zrender-Cg4aFrUj.js";import"./pinia-B3EJDjGG.js";import"./@element-plus-Rv25Faa4.js";import"./pinia-plugin-persistedstate-8SpmOswp.js";import"./destr-CVtkxrq9.js";import"./deep-pick-omit-CegYQlcN.js";import"./lodash-es-C-xrcuFl.js";import"./@popperjs-DB1lLFnh.js";import"./@ctrl-r5W6hzzQ.js";import"./async-validator-CRx4dHSJ.js";import"./memoize-one-BdPwpGay.js";import"./normalize-wheel-es-BQoi3Ox2.js";import"./@floating-ui-BCLhozDd.js";const pe={class:"trace-main-container"},ce={class:"endpoint-div"},de={class:"table-div"},me={class:"pagination-div"},ve={__name:"TraceDashboard",setup(fe){const z=m(!0),s=m([]),_=m(),i=ee(),D=S({lazy:!0,async lazyLoad(t,e){const n=[],{level:I}=t;if(I===0){const d=await W();if(d===null)return;d.result.map(o=>({leaf:!1,value:o,label:o})).forEach(o=>{n.push(o)})}else if(I===1){const d=await Y({query:"",namespace:t.value,pageNum:1,pageSize:1e3});if(d===null)return;d.result.data.map(o=>({leaf:!0,value:o.name,label:o.name===""?"null":o.name})).forEach(o=>{n.push(o)})}e(n)}}),p=S({serviceName:"",pageNum:1,pageSize:10,startTimestamp:"",endTimestamp:""}),N=m(),f=m("");ue(async()=>{i.currentRoute.value.query.serviceName&&(p.serviceName=i.currentRoute.value.query.serviceName,_.value=["default",i.currentRoute.value.query.serviceName],await h()),i.currentRoute.value.query.traceId&&(y.value.includes(i.currentRoute.value.query.traceId)||y.value.push(i.currentRoute.value.query.traceId),f.value=i.currentRoute.value.query.traceId),i.currentRoute.value.query.serviceName&&i.currentRoute.value.query.traceId&&await N.value.getTopology(f.value,z.value,null,null)});const C=m(0),h=async()=>{c.value.splice(0,c.value.length),b.splice(0,b.length),C.value=0,N.value.disposeSpanTopology(),y.value=[],f.value="",p.serviceName=_.value[1];const t=JSON.parse(JSON.stringify(p));s.value!=null&&s.value.length===2?(t.startTimestamp=Date.parse(s.value[0]),t.endTimestamp=Date.parse(s.value[1])):(t.startTimestamp=null,t.endTimestamp=null);const e=await Z(t);e===null||e.result.length===0||(C.value=e.result.length,c.value.splice(0,c.value.length),b.splice(0,b.length),e.result.forEach(n=>{c.value.push(n)}),c.value.forEach(n=>{b.push(n.endPoint)}),y.value=c.value[0].traceIds)};let y=m([]);const c=m([{endPoint:{},traceIds:[]}]),b=S([]),P=async t=>{p.pageSize=t,await h()},U=async t=>{p.pageNum=t,await h()},x=t=>{c.value.forEach(e=>{e.endPoint===t&&(y.value=e.traceIds)})},k=async()=>{let t=null,e=null;s.value!=null&&s.value.length===2&&(t=Date.parse(s.value[0]),e=Date.parse(s.value[1])),await N.value.getTopology(f.value,z.value,t,e)},O=async()=>{const t=te.service({lock:!0,text:"\u6B63\u5728\u6267\u884C\u6570\u636E\u8FD0\u7EF4\u64CD\u4F5C\uFF0C\u8BF7\u7B49\u5F85\u3002",background:"rgba(0, 0, 0, 0.7)"});try{const e=await $();if(e===null||e.result.length===0)return;re.success("\u5220\u9664\u6240\u6709\u94FE\u8DEF\u6570\u636E\u6210\u529F")}finally{t.close(),i.go(0)}};return(t,e)=>{const n=r("el-breadcrumb-item"),I=r("el-breadcrumb"),d=r("el-button"),o=r("el-tooltip"),T=r("el-row"),A=r("el-cascader"),R=r("el-form-item"),J=r("el-date-picker"),B=r("el-form"),H=r("el-divider"),w=r("el-table-column"),L=r("ArrowRightBold"),M=r("el-icon"),Q=r("el-table"),X=r("el-pagination"),V=r("el-col"),j=r("el-option"),F=r("el-select"),G=r("el-switch"),K=r("el-card");return q(),E("div",pe,[a(T,{class:"breadcrumb-header-row"},{default:l(()=>[a(I,{"separator-icon":"ArrowRight"},{default:l(()=>[a(n,{to:{path:"/main"}},{default:l(()=>e[8]||(e[8]=[g(" \u4E3B\u9875 ")])),_:1}),a(n,null,{default:l(()=>e[9]||(e[9]=[g(" \u94FE\u8DEF ")])),_:1}),a(n,{to:{path:"/main/trace/dashboard"}},{default:l(()=>e[10]||(e[10]=[g(" \u8C03\u7528\u94FE\u8DEF ")])),_:1})]),_:1}),a(o,{placement:"bottom"},{content:l(()=>e[11]||(e[11]=[g(" \u70B9\u51FB\u8BE5\u6309\u94AE\u5C06\u4F1A"),v("b",{style:{color:"red"}},"\u5220\u9664\u6240\u6709\u94FE\u8DEF\u6570\u636E",-1),g("\uFF0C\u8BF7\u786E\u4FDD\u60A8\u77E5\u6653\u8BE5\u64CD\u4F5C\u5C06\u5E26\u6765\u7684\u540E\u679C\u3002 "),v("br",null,null,-1),g(" \u5220\u9664\u64CD\u4F5C\u5C06\u9501\u5B9A\u7528\u6237\u754C\u9762\u76F4\u81F3\u5220\u9664\u5B8C\u6210\u3002 ")])),default:l(()=>[a(d,{type:"danger",onClick:O},{default:l(()=>e[12]||(e[12]=[g(" \u5220\u9664\u6240\u6709\u94FE\u8DEF\u6570\u636E ")])),_:1})]),_:1})]),_:1}),a(K,{class:"table-card"},{default:l(()=>[a(T,{class:"cascader-div"},{default:l(()=>[a(B,{inline:!0},{default:l(()=>[a(R,{label:"\u670D\u52A1\u540D\u79F0"},{default:l(()=>[a(A,{placeholder:"\u8BF7\u9009\u62E9\u5BF9\u5E94\u670D\u52A1",modelValue:_.value,"onUpdate:modelValue":e[0]||(e[0]=u=>_.value=u),clearable:"",props:D,"show-all-levels":!1,onChange:h},null,8,["modelValue","props"])]),_:1}),a(R,{label:"\u8D77\u6B62\u65F6\u95F4"},{default:l(()=>[a(J,{modelValue:s.value,"onUpdate:modelValue":e[1]||(e[1]=u=>s.value=u),type:"datetimerange","range-separator":"\u5230","start-placeholder":"\u5F00\u59CB\u65F6\u95F4","end-placeholder":"\u7ED3\u675F\u65F6\u95F4",onClear:h,onChange:h},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),a(H),a(T,{gutter:10,style:{"margin-top":"2%"}},{default:l(()=>[a(V,{span:8},{default:l(()=>[e[13]||(e[13]=v("div",null,"\u8FFD\u8E2A\u7AEF\u70B9\u4FE1\u606F",-1)),v("div",ce,[v("div",de,[a(Q,{data:b,stripe:""},{default:l(()=>[a(w,{prop:"serviceName",label:"\u670D\u52A1\u540D\u79F0"}),a(w,{prop:"ip",label:"IP\u5730\u5740"}),a(w,{prop:"port",label:"\u7AEF\u53E3\u53F7"}),a(w,{prop:"latency",label:"\u65F6\u5EF6"}),a(w,{fixed:"right",label:"\u7ED8\u56FE"},{default:l(u=>[a(o,{effect:"light",content:"\u67E5\u770BEndpoint\u6240\u5728\u94FE\u8DEF\u4FE1\u606F",placement:"top",enterable:!1},{default:l(()=>[a(d,{type:"primary",circle:"",size:"small",onClick:he=>x(u.row)},{default:l(()=>[a(M,null,{default:l(()=>[a(L)]),_:1})]),_:2},1032,["onClick"])]),_:2},1024)]),_:1})]),_:1},8,["data"])]),v("div",me,[a(X,{"current-page":p.pageNum,"onUpdate:currentPage":e[2]||(e[2]=u=>p.pageNum=u),"page-size":p.pageSize,"onUpdate:pageSize":e[3]||(e[3]=u=>p.pageSize=u),"page-sizes":[2,5,10,20],layout:"total, pager, sizes",total:C.value,"pager-count":5,onSizeChange:P,onCurrentChange:U},null,8,["current-page","page-size","total"])])])]),_:1}),a(V,{span:16},{default:l(()=>[v("div",null,[e[14]||(e[14]=v("div",null,"Span\u8C03\u7528\u56FE",-1)),a(T,{gutter:15},{default:l(()=>[a(V,{span:12},{default:l(()=>[a(R,{label:"TraceId"},{default:l(()=>[a(F,{modelValue:f.value,"onUpdate:modelValue":e[4]||(e[4]=u=>f.value=u),placeholder:"\u8BF7\u5728\u5DE6\u4FA7\u9009\u62E9Endpoint\u540E\uFF0C\u9009\u62E9TraceId",style:{width:"90%"},clearable:"",onChange:e[5]||(e[5]=u=>k())},{default:l(()=>[(q(!0),E(oe,null,ne(se(y),u=>(q(),ie(j,{key:u,label:u,value:u},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1}),a(V,{span:12},{default:l(()=>[a(R,null,{default:l(()=>[a(G,{"active-text":"\u4EC5\u67E5\u770B\u5C5E\u4E8E\u5F53\u524Dservice\u7684span","inactive-text":"\u67E5\u770B\u5F53\u524Dtrace\u4E0B\u7684\u6240\u6709span",modelValue:z.value,"onUpdate:modelValue":e[6]||(e[6]=u=>z.value=u),size:"small",onChange:e[7]||(e[7]=u=>k())},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})]),a(ae,{ref_key:"traceTopologyDiagramRef",ref:N,"service-name":_.value},null,8,["service-name"])]),_:1})]),_:1})]),_:1})])}}},ge=le(ve,[["__scopeId","data-v-60de39d2"]]);export{ge as default};
