import{_ as A,a as ae,g as le}from"./index-BbUvg7bG.js";import{E as _}from"./element-plus-Ca8QSiiZ.js";import{b as te}from"./@vueuse-mXDpITa_.js";import{i as re}from"./echarts-BRPGUpj0.js";import{u as ne}from"./vue-router-CnZi-aoE.js";import{t as D}from"./dateUtil-NlCD2qvi.js";import{_ as ie}from"./index-DIK4YnR8.js";import{r as f,Z as q,b as oe,D as ue,w as se,c as O,V as l,P as t,ai as r,o as V,a as d,F as de,a8 as ce,u as pe,O as me}from"./@vue-CVZDnyeU.js";import"./axios-CCb-kr4I.js";import"./nprogress-DrSneiWl.js";import"./dayjs-DuEr9S7h.js";import"./lodash-es-D0J8aJCM.js";import"./@element-plus-0Z6e8VG0.js";import"./@popperjs-CsO2-mKt.js";import"./@ctrl-r5W6hzzQ.js";import"./async-validator-BTg-XjMW.js";import"./memoize-one-BdPwpGay.js";import"./normalize-wheel-es-B6fDCfyv.js";import"./@floating-ui-fabFPCLu.js";import"./tslib-BDyQ-Jie.js";import"./zrender-UROijHWN.js";import"./pinia-yF2WvYur.js";import"./pinia-plugin-persistedstate-Bts6f1YT.js";const ve=async h=>{try{const{data:n}=await A.get("/trace/endPoints",{params:{serviceName:h.serviceName,pageNum:h.pageNum,pageSize:h.pageSize}});return n.code!==null&&n.code===2e3?n:n.code!==null?(_.error(`\u83B7\u53D6traceId\u8868\u5931\u8D25, ${n.message}`),null):(_.error("\u83B7\u53D6traceId\u8868\u5931\u8D25"),null)}catch(n){_.error(`\u83B7\u53D6traceId\u8868\u5931\u8D25, ${n.message}`)}return null},ge=async(h,n,u)=>{try{const{data:c}=await A.get("/trace/topology",{params:{traceId:h,serviceName:n,innerService:u}});return c.code!==null&&c.code===2e3?c:c.code!==null?(_.error(`\u83B7\u53D6trace\u4E0B\u62D3\u6251\u5931\u8D25, ${c.message}`),null):(_.error("\u83B7\u53D6trace\u4E0B\u62D3\u6251\u5931\u8D25"),null)}catch(c){_.error(`\u83B7\u53D6trace\u4E0B\u62D3\u6251\u5931\u8D25, ${c.message}`)}return null},fe={class:"trace-main-container"},he={class:"cascader-div"},ye={class:"endpoint-div"},be={class:"table-div"},we={class:"pagination-div"},_e={__name:"TraceMain",setup(h){const n=f(),u=ne(),c=q({lazy:!0,async lazyLoad(e,a){const v=[],{level:w}=e;if(w===0){const s=await ae();if(s===null)return;s.result.map(o=>({leaf:!1,value:o,label:o})).forEach(o=>{v.push(o)})}else if(w===1){const s=await le({query:"",namespace:e.value,pageNum:1,pageSize:1e3});if(s===null)return;s.result.data.map(o=>({leaf:!0,value:o.name,label:o.name===""?"null":o.name})).forEach(o=>{v.push(o)})}a(v)}}),p=q({serviceName:"",pageNum:1,pageSize:10});let S;const $=()=>{m&&m.resize()};oe(async()=>{window.addEventListener("resize",$),S=new ResizeObserver(()=>$),S.observe(document.getElementById("trace-topology-div")),u.currentRoute.value.query.serviceName&&(p.serviceName=u.currentRoute.value.query.serviceName,n.value=["default",u.currentRoute.value.query.serviceName],await N()),u.currentRoute.value.query.traceId&&(y.value.includes(u.currentRoute.value.query.traceId)||y.value.push(u.currentRoute.value.query.traceId),g.value=u.currentRoute.value.query.traceId),u.currentRoute.value.query.serviceName&&u.currentRoute.value.query.traceId&&await k()}),ue(()=>{window.removeEventListener("resize",$),S.disconnect()});const R=f(0),N=async()=>{b.value.splice(0,b.value.length),E.splice(0,E.length),R.value=0,m&&m.dispose(),y.value=[],g.value="",p.serviceName=n.value[1];const e=await ve(p);e===null||e.result.length===0||(R.value=e.result.length,e.result.forEach(a=>{b.value.push(a)}),b.value.forEach(a=>{E.push(a.endPoint)}),y.value=b.value[0].traceIds)};let y=f([]);const b=f([{endPoint:{},traceIds:[]}]),E=q([]),B=async e=>{p.pageSize=e,await N()},L=async e=>{p.pageNum=e,await N()},j=e=>{b.value.forEach(a=>{a.endPoint===e&&(y.value=a.traceIds)})},g=f(),T=f({name:"",value:"",collapsed:!1,children:[]}),C=f(!0),k=async()=>{if(g.value===""||g.value===void 0)return;const e=await ge(g.value,n.value[1],C.value);e!==null&&(T.value=e.result,x())};let m;const z=te("theme-appearance","auto");se(z,()=>{x()});function F(e){const a=e.endTime==="-1"?"\u5F02\u5E38\u6216\u79BB\u7EBF":"\u6B63\u5E38",v=D(e.startTime),w=e.endTime==="-1"?"\u8BE5Span\u5F02\u5E38":D(e.endTime),s=e.localEndPoint.ip===""?"null":e.localEndPoint.ip,o=e.remoteEndPoint.ip===""?"null":e.remoteEndPoint.ip;return`<div>
                    <div>
                        <b>\u5F53\u524DSpan\u8BE6\u7EC6\u60C5\u51B5</b>
                    </div>
                    <ul>
                        <li>id: ${e.id}</li>
                        <li>\u540D\u79F0: ${e.name}</li>
                        <li>\u6240\u5C5E\u670D\u52A1: ${e.serviceName}</li>
                        <li>\u5F00\u59CB\u65F6\u95F4: ${v}</li>
                        <li>\u7ED3\u675F\u65F6\u95F4: ${w}</li>
                        <li>span\u72B6\u6001: ${a}</li>
                        <li>\u7236\u8282\u70B9SpanId: ${e.parentSpanId}</li>
                        <li>\u6240\u5C5EendPoint: ${e.localEndPoint.serviceName}</li>
                        <li>\u6240\u5C5EendPoint ip\u4E0E\u7AEF\u53E3: ${s}:${e.localEndPoint.port}</li>
                        <li>\u8FDC\u7A0BendPoint: ${e.remoteEndPoint.serviceName}</li>
                        <li>\u8FDC\u7A0BendPoint ip\u4E0E\u7AEF\u53E3: ${o}:${e.remoteEndPoint.port}</li>
                    </ul>
                </div>`}const x=()=>{m&&m.dispose();let e={title:{subtext:"\u7EFF\u8272\u4E3A\u6B63\u5E38Span\u8282\u70B9\uFF0C\u7EA2\u8272\u4E3A\u5F02\u5E38Span\u8282\u70B9",align:"right"},backgroundColor:z.value==="dark"?"#212224":"#fff",tooltip:{trigger:"item",triggerOn:"mousemove",backgroundColor:z.value==="dark"?"#212224":"#fff",textStyle:{color:z.value==="dark"?"#fff":"#212224"},formatter:function(a){return F(a.data.span)}},series:[{type:"tree",symbol:"circle",roam:!0,expandAndCollapse:!0,animationDuration:550,animationDurationUpdate:750,label:{position:"right",verticalAlign:"middle",fontSize:9},initialTreeDepth:-1,data:[T.value]}]};m=re(document.getElementById("trace-topology-div"),z.value==="dark"?"dark":"light"),m.setOption(e)};return(e,a)=>{const v=r("el-breadcrumb-item"),w=r("el-breadcrumb"),s=r("el-row"),o=r("el-cascader"),M=r("el-divider"),I=r("el-table-column"),Z=r("ArrowRightBold"),G=r("el-icon"),H=r("el-button"),J=r("el-tooltip"),K=r("el-table"),Q=r("el-pagination"),P=r("el-col"),W=r("el-option"),X=r("el-select"),U=r("el-form-item"),Y=r("el-switch"),ee=r("el-card");return V(),O("div",fe,[l(s,null,{default:t(()=>[l(w,{"separator-icon":"ArrowRight"},{default:t(()=>[l(v,null,{default:t(()=>a[5]||(a[5]=[d("a",{href:"/main"},"\u4E3B\u9875",-1)])),_:1}),l(v,null,{default:t(()=>a[6]||(a[6]=[d("a",{href:"/main/trace"},"\u94FE\u8DEF\u4FE1\u606F",-1)])),_:1})]),_:1})]),_:1}),l(ee,{class:"table-card"},{default:t(()=>[d("div",he,[l(o,{placeholder:"\u8BF7\u9009\u62E9\u5BF9\u5E94\u670D\u52A1",modelValue:n.value,"onUpdate:modelValue":a[0]||(a[0]=i=>n.value=i),style:{width:"40%"},clearable:"",props:c,"show-all-levels":!1,onChange:N},null,8,["modelValue","props"])]),l(M),l(s,{gutter:10,style:{"margin-top":"2%"}},{default:t(()=>[l(P,{span:8},{default:t(()=>[a[7]||(a[7]=d("div",null,"\u8FFD\u8E2A\u7AEF\u70B9\u4FE1\u606F",-1)),d("div",ye,[d("div",be,[l(K,{data:E,stripe:""},{default:t(()=>[l(I,{prop:"serviceName",label:"\u670D\u52A1\u540D\u79F0"}),l(I,{prop:"ip",label:"IP\u5730\u5740"}),l(I,{prop:"port",label:"\u7AEF\u53E3\u53F7"}),l(I,{prop:"latency",label:"\u65F6\u5EF6"}),l(I,{fixed:"right",label:"\u7ED8\u56FE"},{default:t(i=>[l(J,{effect:"light",content:"\u67E5\u770BEndpoint\u6240\u5728\u94FE\u8DEF\u4FE1\u606F",placement:"top",enterable:!1},{default:t(()=>[l(H,{type:"primary",circle:"",size:"small",onClick:Ie=>j(i.row)},{default:t(()=>[l(G,null,{default:t(()=>[l(Z)]),_:1})]),_:2},1032,["onClick"])]),_:2},1024)]),_:1})]),_:1},8,["data"])]),d("div",we,[l(Q,{"current-page":p.pageNum,"onUpdate:currentPage":a[1]||(a[1]=i=>p.pageNum=i),"page-size":p.pageSize,"onUpdate:pageSize":a[2]||(a[2]=i=>p.pageSize=i),"page-sizes":[2,5,10,20],layout:"total, pager, sizes",total:R.value,"pager-count":5,onSizeChange:B,onCurrentChange:L},null,8,["current-page","page-size","total"])])])]),_:1}),l(P,{span:16},{default:t(()=>[d("div",null,[a[8]||(a[8]=d("div",null,"Span\u8C03\u7528\u56FE",-1)),l(s,{gutter:15},{default:t(()=>[l(P,{span:12},{default:t(()=>[l(U,{label:"TraceId"},{default:t(()=>[l(X,{modelValue:g.value,"onUpdate:modelValue":a[3]||(a[3]=i=>g.value=i),placeholder:"\u8BF7\u5728\u5DE6\u4FA7\u9009\u62E9Endpoint\u540E\uFF0C\u9009\u62E9TraceId",style:{width:"90%"},clearable:"",onChange:k},{default:t(()=>[(V(!0),O(de,null,ce(pe(y),i=>(V(),me(W,{key:i,label:i,value:i},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1}),l(P,{span:12},{default:t(()=>[l(U,null,{default:t(()=>[l(Y,{"active-text":"\u4EC5\u67E5\u770B\u5C5E\u4E8E\u5F53\u524Dservice\u7684span","inactive-text":"\u67E5\u770B\u5F53\u524Dtrace\u4E0B\u7684\u6240\u6709span",modelValue:C.value,"onUpdate:modelValue":a[4]||(a[4]=i=>C.value=i),size:"small",onChange:k},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})]),a[9]||(a[9]=d("div",{id:"trace-topology-div"},null,-1))]),_:1})]),_:1})]),_:1})])}}},ze=ie(_e,[["__scopeId","data-v-4a3db3e0"]]);export{ze as default};
