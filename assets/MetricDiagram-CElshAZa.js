import{r as N,w as k,b as E,W as A,J as L,R as z,o as y,c as h,P as I,a4 as M,a as O}from"./@vue-DJGElsCt.js";import{b as _}from"./@vueuse-BK87aVxb.js";import{i as D}from"./echarts-BIEvihnk.js";import{_ as x}from"./index-C-47mxwj.js";import{E as o,a as F}from"./element-plus-CB4diBvn.js";import{t as R}from"./dateUtil-NlCD2qvi.js";import{_ as B}from"./index-CLELspwH.js";const G=async a=>{try{const{data:l}=await x.get("/metrics",{params:{serviceName:a.serviceName,metricNameLimit:a.metricNameLimit,startTimeStamp:a.startTimeStamp,endTimeStamp:a.endTimeStamp}});return l.code!==null&&l.code===2e3?l:l.code!==null?(o.error(`\u83B7\u53D6\u6570\u503C\u5217\u8868\u5931\u8D25, ${l.message}`),null):(o.error("\u83B7\u53D6\u6570\u503C\u5217\u8868\u5931\u8D25"),null)}catch(l){o.error(`\u83B7\u53D6\u6570\u503C\u5217\u8868\u5931\u8D25, ${l.message}`)}return null},U=async()=>{try{const{data:a}=await x.delete("/metrics");return a.code!==null&&a.code===2e3?a:a.code!==null?(o.error(`\u5220\u9664\u6240\u6709\u6570\u503C\u5931\u8D25, ${a.message}`),null):(o.error("\u5220\u9664\u6240\u6709\u6570\u503C\u5931\u8D25"),null)}catch(a){o.error(`\u5220\u9664\u6240\u6709\u6570\u503C\u5931\u8D25, ${a.message}`)}return null},W={class:"graph-div"},C=["id"],$={__name:"MetricDiagram",props:{metricQueryDto:Object,startAndStopTime:Array},setup(a,{expose:l}){const p=N(!0),n=a;function S(){const e=JSON.parse(JSON.stringify(n.metricQueryDto));if(e.serviceName==="null"&&(e.serviceName=""),e.metricNameLimit===0&&(e.metricNameLimit=null),n.startAndStopTime.length===2)e.startTimeStamp=Date.parse(n.startAndStopTime[0]),e.endTimeStamp=Date.parse(n.startAndStopTime[1]);else{o.warning("\u5F53\u524D\u4E3A\u6B63\u5F0F\u73AF\u5883, \u65F6\u95F4\u8303\u56F4\u7F6E\u7A7A\u65F6\u9ED8\u8BA4\u83B7\u53D6\u8FD1\u534A\u4E2A\u5C0F\u65F6\u5185\u7684\u6570\u503C");const i=new Date;e.startTimeStamp=i.getTime()-30*60*1e3,e.endTimeStamp=i.getTime()}return e}const c=N([{name:"",serviceName:"",metricType:"",metrics:[]}]);l({toggleMetrics:async()=>{u.forEach(r=>r.dispose()),c.value=[],p.value=!0;const e=S();let i;try{i=F.service({lock:!0,text:"\u6B63\u5728\u641C\u7D22\uFF0C\u6570\u636E\u91CF\u8F83\u5927\uFF0C\u8BF7\u8010\u5FC3\u7B49\u5F85",background:"rgba(0, 0, 0, 0.7)"});const r=await G(e);if(r===null)return;if(r.result&&r.result.length!==0){for(p.value=!1,r.result.forEach(s=>{s.metrics.forEach(t=>{t.timestamp=R(t.timestamp)})}),c.value=r.result;!document.getElementById("metric-graph-"+(c.value.length-1));)await new Promise(s=>setTimeout(s,100));for(let s=0;s<c.value.length;s++)try{b(c.value[s],s)}catch(t){o.error(t)}}else p.value=!0}finally{i.close()}}});let u=[];const d=_("theme-appearance","auto");k(d,()=>{u.forEach(e=>e.dispose());for(let e=0;e<n.metricList.length;e++)try{b(n.metricList[e],e)}catch(i){o.error(i)}});let f;E(()=>{u.forEach(e=>e.dispose()),window.addEventListener("resize",g),f=new ResizeObserver(()=>g),f.observe(document.getElementById("metricCardRef"))}),A(()=>{window.removeEventListener("resize",g),f.disconnect()});const g=()=>{u&&u.forEach(e=>{e.resize()})};function T(e,i){return{backgroundColor:d.value==="dark"?"#212224":"#fff",title:{text:e.name.replace(/_/g," "),textStyle:{fontWeight:"bold",fontSize:14,lineHeight:16,width:document.getElementById("metric-graph-"+i).offsetWidth-20,overflow:"break"},subtext:e.metrics[0].description?e.metrics[0].description:"",subtextStyle:{fontSize:10,lineHeight:12,width:document.getElementById("metric-graph-"+i).offsetWidth-20,overflow:"break"}},tooltip:{trigger:"item",axisPointer:{type:"cross"},backgroundColor:d.value==="dark"?"#212224":"#fff",textStyle:{color:d.value==="dark"?"#fff":"#212224"}}}}const v=e=>Number(e)>1e9?"G":Number(e)>1e6?"M":Number(e)>1e3?"K":null,b=(e,i)=>{let r=T(e,i);if(e.metricType==="GAUGE"||e.metricType==="COUNTER")e.metrics.length>=2?(r.xAxis={type:"category",data:e.metrics.map(t=>t.timestamp)},r.yAxis={type:"value",name:v(e.metrics[e.metrics.length-1].value)===null?null:"Unit:"+v(e.metrics[0].value),nameLocation:"start",nameGap:20},r.series=[{data:e.metrics.map(t=>Number(t.value)>1e9?(Number(t.value)/1e9).toFixed(2):Number(t.value)>1e6?(Number(t.value)/1e6).toFixed(2):Number(t.value)>1e3?(Number(t.value)/1e3).toFixed(2):t.value),type:"line"}]):(r.series=[{type:"scatter",symbolSize:1,data:[{value:[0,0],label:{show:!0,formatter:e.metrics[0].value+"",fontSize:20,fontWeight:"bold",color:d.value==="dark"?"#ff0000":"#992233"}}]}],r.xAxis={show:!1,min:-1,max:1},r.yAxis={show:!1,min:-1,max:1});else if(e.metricType==="HISTOGRAM"||e.metricType==="SUMMARY"){let t=[];for(const m in e.metrics[0].buckets)t.push({key:m,value:e.metrics[0].buckets[m]});t.sort((m,w)=>m.key-w.key),r.xAxis={type:"category",data:t.map(m=>m.key)},r.yAxis={type:"value",name:v(t[t.length-1].value)===null?null:"Unit:"+v(t[t.length-1].value)},r.series=[{data:t.map(m=>Number(m.value)>1e9?(Number(m.value)/1e9).toFixed(2):Number(m.value)>1e6?(Number(m.value)/1e6).toFixed(2):Number(m.value)>1e3?(Number(m.value)/1e3).toFixed(2):m.value),type:"bar"}]}let s=D(document.getElementById("metric-graph-"+i),d.value==="dark"?"dark":"light");s.setOption(r),u.push(s)};return(e,i)=>L((y(),h("div",W,[(y(!0),h(I,null,M(c.value,(r,s)=>(y(),h("div",{class:"graph-card",key:s},[O("div",{class:"graph-item",id:"metric-graph-"+s},null,8,C)]))),128))],512)),[[z,!p.value]])}},H=B($,[["__scopeId","data-v-44772a58"]]);export{H as M,U as d};
