import{_ as T,a as Y,g as ee}from"./index-BIGPZr2-.js";import{E as b}from"./element-plus-CqEfOaYE.js";import{b as ae}from"./@vueuse-CMkOXHT3.js";import{i as le}from"./echarts-CAET2t7N.js";import{u as te}from"./vue-router-DNZaI-R-.js";import{t as V}from"./dateUtil-NlCD2qvi.js";import{_ as re}from"./index-ItcoEKTc.js";import{r as w,Z as R,b as ne,D as ie,w as oe,c as x,V as l,P as i,ai as r,o as k,a as c,F as ue,a8 as se,u as ce,O as de}from"./@vue-9d-ZWrow.js";import"./axios-BimPEqV4.js";import"./nprogress-DrSneiWl.js";import"./dayjs-DuEr9S7h.js";import"./lodash-es-D0J8aJCM.js";import"./@element-plus-DNs7Qi0T.js";import"./@popperjs-CsO2-mKt.js";import"./@ctrl-r5W6hzzQ.js";import"./async-validator-BTg-XjMW.js";import"./memoize-one-BdPwpGay.js";import"./normalize-wheel-es-B6fDCfyv.js";import"./@floating-ui-CW9Ge4bl.js";import"./tslib-BDyQ-Jie.js";import"./zrender-B5ljRYTo.js";import"./pinia-yt7DUaCk.js";import"./pinia-plugin-persistedstate-Bts6f1YT.js";const pe=async g=>{try{const{data:n}=await T.get("/trace/endPoints",{params:{serviceName:g.serviceName,pageNum:g.pageNum,pageSize:g.pageSize}});return n.code!==null&&n.code===2e3?n:n.code!==null?(b.error(`\u83B7\u53D6traceId\u8868\u5931\u8D25, ${n.message}`),null):(b.error("\u83B7\u53D6traceId\u8868\u5931\u8D25"),null)}catch(n){b.error(`\u83B7\u53D6traceId\u8868\u5931\u8D25, ${n.message}`)}return null},me=async(g,n)=>{try{const{data:t}=await T.get("/trace/topology",{params:{traceId:g,serviceName:n}});return t.code!==null&&t.code===2e3?t:t.code!==null?(b.error(`\u83B7\u53D6trace\u4E0B\u62D3\u6251\u5931\u8D25, ${t.message}`),null):(b.error("\u83B7\u53D6trace\u4E0B\u62D3\u6251\u5931\u8D25"),null)}catch(t){b.error(`\u83B7\u53D6trace\u4E0B\u62D3\u6251\u5931\u8D25, ${t.message}`)}return null},ve={class:"trace-main-container"},ge={class:"cascader-div"},fe={class:"endpoint-div"},ye={class:"table-div"},he={class:"pagination-div"},be={__name:"TraceMain",setup(g){const n=w(),t=te(),U=R({lazy:!0,async lazyLoad(e,a){const m=[],{level:h}=e;if(h===0){const s=await Y();if(s===null)return;s.result.map(o=>({leaf:!1,value:o,label:o})).forEach(o=>{m.push(o)})}else if(h===1){const s=await ee({query:"",namespace:e.value,pageNum:1,pageSize:1e3});if(s===null)return;s.result.data.map(o=>({leaf:!0,value:o.name,label:o.name===""?"null":o.name})).forEach(o=>{m.push(o)})}a(m)}}),d=R({serviceName:"",pageNum:1,pageSize:10});let N;const P=()=>{p&&p.resize()};ne(async()=>{t.currentRoute.value.query.serviceName&&(d.serviceName=t.currentRoute.value.query.serviceName,n.value=t.currentRoute.value.query.serviceName,await E()),t.currentRoute.value.query.traceId&&(f.value.includes(t.currentRoute.value.query.traceId)||f.value.push(t.currentRoute.value.query.traceId),v.value=t.currentRoute.value.query.traceId),t.currentRoute.value.query.serviceName&&t.currentRoute.value.query.traceId&&$(),window.addEventListener("resize",P),N=new ResizeObserver(()=>P),N.observe(document.getElementById("trace-topology-div"))}),ie(()=>{window.removeEventListener("resize",P),N.disconnect()});const S=w(0),E=async()=>{y.value.splice(0,y.value.length),I.splice(0,I.length),S.value=0,p&&p.dispose(),f.value=[],v.value="",d.serviceName=n.value[1];const e=await pe(d);e!==null&&(S.value=e.result.length,e.result.forEach(a=>{y.value.push(a)}),y.value.forEach(a=>{I.push(a.endPoint)}),f.value=y.value[0].traceIds)};let f=w([]);const y=w([{endPoint:{},traceIds:[]}]),I=R([]),A=async e=>{d.pageSize=e,await E()},D=async e=>{d.pageNum=e,await E()},O=e=>{y.value.forEach(a=>{a.endPoint===e&&(f.value=a.traceIds)})},v=w(),q=w({name:"",value:"",collapsed:!1,children:[]}),B=async()=>{if(v.value===""||v.value===void 0)return;const e=await me(v.value,n.value[1]);e!==null&&(q.value=e.result,$())};let p;const _=ae("theme-appearance","auto");oe(_,()=>{$()});function L(e){const a=e.endTime===-1?"\u5F02\u5E38\u6216\u79BB\u7EBF":"\u6B63\u5E38",m=V(e.startTime),h=e.endTime===-1?"\u8BE5Span\u5F02\u5E38":V(e.endTime),s=e.localEndPoint.ip===""?"null":e.localEndPoint.ip,o=e.remoteEndPoint.ip===""?"null":e.remoteEndPoint.ip;return`<div>
                    <div>
                        <b>\u5F53\u524DSpan\u8BE6\u7EC6\u60C5\u51B5</b>
                    </div>
                    <ul>
                        <li>id: ${e.id}</li>
                        <li>\u540D\u79F0: ${e.name}</li>
                        <li>\u5F00\u59CB\u65F6\u95F4: ${m}</li>
                        <li>\u7ED3\u675F\u65F6\u95F4: ${h}</li>
                        <li>span\u72B6\u6001: ${a}</li>
                        <li>\u7236\u8282\u70B9SpanId: ${e.parentSpanId}</li>
                        <li>\u6240\u5C5EendPoint: ${e.localEndPoint.serviceName}</li>
                        <li>\u6240\u5C5EendPoint ip\u4E0E\u7AEF\u53E3: ${s}:${e.localEndPoint.port}</li>
                        <li>\u8FDC\u7A0BendPoint: ${e.remoteEndPoint.serviceName}</li>
                        <li>\u8FDC\u7A0BendPoint ip\u4E0E\u7AEF\u53E3: ${o}:${e.remoteEndPoint.port}</li>
                    </ul>
                </div>`}const $=()=>{p&&p.dispose();let e={title:{subtext:"\u7EFF\u8272\u4E3A\u6B63\u5E38Span\u8282\u70B9\uFF0C\u7EA2\u8272\u4E3A\u5F02\u5E38Span\u8282\u70B9",align:"right"},backgroundColor:_.value==="dark"?"#212224":"#fff",tooltip:{trigger:"item",triggerOn:"mousemove",backgroundColor:_.value==="dark"?"#212224":"#fff",textStyle:{color:_.value==="dark"?"#fff":"#212224"},formatter:function(a){return L(a.data.span)}},series:[{type:"tree",symbol:"circle",roam:!0,expandAndCollapse:!0,animationDuration:550,animationDurationUpdate:750,label:{position:"right",verticalAlign:"middle",fontSize:9},initialTreeDepth:-1,data:[q.value]}]};p=le(document.getElementById("trace-topology-div"),_.value==="dark"?"dark":"light"),p.setOption(e)};return(e,a)=>{const m=r("el-breadcrumb-item"),h=r("el-breadcrumb"),s=r("el-row"),o=r("el-cascader"),F=r("el-divider"),z=r("el-table-column"),J=r("ArrowRightBold"),M=r("el-icon"),Z=r("el-button"),j=r("el-tooltip"),G=r("el-table"),H=r("el-pagination"),C=r("el-col"),K=r("el-option"),Q=r("el-select"),W=r("el-form-item"),X=r("el-card");return k(),x("div",ve,[l(s,null,{default:i(()=>[l(h,{"separator-icon":"ArrowRight"},{default:i(()=>[l(m,null,{default:i(()=>a[4]||(a[4]=[c("a",{href:"/main"},"\u4E3B\u9875",-1)])),_:1}),l(m,null,{default:i(()=>a[5]||(a[5]=[c("a",{href:"/main/trace"},"\u94FE\u8DEF\u4FE1\u606F",-1)])),_:1})]),_:1})]),_:1}),l(X,{class:"table-card"},{default:i(()=>[c("div",ge,[l(o,{placeholder:"\u8BF7\u9009\u62E9\u5BF9\u5E94\u670D\u52A1",modelValue:n.value,"onUpdate:modelValue":a[0]||(a[0]=u=>n.value=u),style:{width:"40%"},clearable:"",props:U,"show-all-levels":!1,onChange:E},null,8,["modelValue","props"])]),l(F),l(s,{gutter:10,style:{"margin-top":"2%"}},{default:i(()=>[l(C,{span:8},{default:i(()=>[a[6]||(a[6]=c("div",null,"\u8FFD\u8E2A\u7AEF\u70B9\u4FE1\u606F",-1)),c("div",fe,[c("div",ye,[l(G,{data:I,stripe:""},{default:i(()=>[l(z,{prop:"serviceName",label:"\u670D\u52A1\u540D\u79F0"}),l(z,{prop:"ip",label:"IP\u5730\u5740"}),l(z,{prop:"port",label:"\u7AEF\u53E3\u53F7"}),l(z,{prop:"latency",label:"\u65F6\u5EF6"}),l(z,{fixed:"right",label:"\u7ED8\u56FE"},{default:i(u=>[l(j,{effect:"light",content:"\u67E5\u770BEndpoint\u6240\u5728\u94FE\u8DEF\u4FE1\u606F",placement:"top",enterable:!1},{default:i(()=>[l(Z,{type:"primary",circle:"",size:"small",onClick:_e=>O(u.row)},{default:i(()=>[l(M,null,{default:i(()=>[l(J)]),_:1})]),_:2},1032,["onClick"])]),_:2},1024)]),_:1})]),_:1},8,["data"])]),c("div",he,[l(H,{"current-page":d.pageNum,"onUpdate:currentPage":a[1]||(a[1]=u=>d.pageNum=u),"page-size":d.pageSize,"onUpdate:pageSize":a[2]||(a[2]=u=>d.pageSize=u),"page-sizes":[2,5,10,20],layout:"total, pager, sizes",total:S.value,"pager-count":5,onSizeChange:A,onCurrentChange:D},null,8,["current-page","page-size","total"])])])]),_:1}),l(C,{span:16},{default:i(()=>[c("div",null,[a[7]||(a[7]=c("div",null,"Span\u8C03\u7528\u56FE",-1)),l(W,{label:"TraceId"},{default:i(()=>[l(Q,{modelValue:v.value,"onUpdate:modelValue":a[3]||(a[3]=u=>v.value=u),placeholder:"\u8BF7\u5728\u5DE6\u4FA7\u9009\u62E9Endpoint\u540E\uFF0C\u9009\u62E9TraceId",style:{width:"40%"},clearable:"",onChange:B},{default:i(()=>[(k(!0),x(ue,null,se(ce(f),u=>(k(),de(K,{key:u,label:u,value:u},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),a[8]||(a[8]=c("div",{id:"trace-topology-div"},null,-1))]),_:1})]),_:1})]),_:1})])}}},we=re(be,[["__scopeId","data-v-af893858"]]);export{we as default};
