import{_ as x,a as W,g as X}from"./index-rpUdClTr.js";import{E as h}from"./element-plus-Du0MvhR9.js";import{b as Y}from"./@vueuse-C5GirQr1.js";import{i as ee}from"./echarts-CAET2t7N.js";import{u as ae}from"./vue-router-CdM3SS_q.js";import{_ as le}from"./index-L2XZOxFW.js";import{r as b,Z as q,b as te,D as re,w as oe,c as D,V as a,P as u,ai as r,o as C,a as s,F as ue,a8 as ne,u as ie,O as se}from"./@vue-BN9FX5Kd.js";import"./axios-BimPEqV4.js";import"./nprogress-DrSneiWl.js";import"./dayjs-DuEr9S7h.js";import"./lodash-es-D0J8aJCM.js";import"./@element-plus-BjWKHK4M.js";import"./@popperjs-CsO2-mKt.js";import"./@ctrl-r5W6hzzQ.js";import"./async-validator-BTg-XjMW.js";import"./memoize-one-BdPwpGay.js";import"./normalize-wheel-es-B6fDCfyv.js";import"./@floating-ui-CW9Ge4bl.js";import"./tslib-BDyQ-Jie.js";import"./zrender-B5ljRYTo.js";import"./pinia-CWoSVrwJ.js";import"./pinia-plugin-persistedstate-Bts6f1YT.js";const ce=async v=>{try{const{data:o}=await x.get("/trace/endPoints",{params:{serviceName:v.serviceName,pageNum:v.pageNum,pageSize:v.pageSize}});return o.code!==null&&o.code===2e3?o:o.code!==null?(h.error(`\u83B7\u53D6traceId\u8868\u5931\u8D25, ${o.message}`),null):(h.error("\u83B7\u53D6traceId\u8868\u5931\u8D25"),null)}catch(o){h.error(`\u83B7\u53D6traceId\u8868\u5931\u8D25, ${o.message}`)}return null},de=async(v,o)=>{try{const{data:t}=await x.get("/trace/topology",{params:{traceId:v,serviceName:o}});return t.code!==null&&t.code===2e3?t:t.code!==null?(h.error(`\u83B7\u53D6trace\u4E0B\u62D3\u6251\u5931\u8D25, ${t.message}`),null):(h.error("\u83B7\u53D6trace\u4E0B\u62D3\u6251\u5931\u8D25"),null)}catch(t){h.error(`\u83B7\u53D6trace\u4E0B\u62D3\u6251\u5931\u8D25, ${t.message}`)}return null},pe={class:"trace-main-container"},me={class:"cascader-div"},ve={class:"endpoint-div"},ge={class:"table-div"},fe={class:"pagination-div"},ye={__name:"TraceMain",setup(v){const o=b(),t=ae(),U=q({lazy:!0,async lazyLoad(l,e){const y=[],{level:I}=l;if(I===0){const p=await W();if(p===null)return;p.result.map(i=>({leaf:!1,value:i,label:i})).forEach(i=>{y.push(i)})}else if(I===1){const p=await X({query:"",namespace:l.value,pageNum:1,pageSize:1e3});if(p===null)return;p.result.data.map(i=>({leaf:!0,value:i.name,label:i.name===""?"null":i.name})).forEach(i=>{y.push(i)})}e(y)}}),c=q({serviceName:"",pageNum:1,pageSize:10});let E;const R=()=>{d&&d.resize()};te(async()=>{t.currentRoute.value.query.serviceName&&(c.serviceName=t.currentRoute.value.query.serviceName,o.value=t.currentRoute.value.query.serviceName,await z()),t.currentRoute.value.query.traceId&&(g.value.includes(t.currentRoute.value.query.traceId)||g.value.push(t.currentRoute.value.query.traceId),m.value=t.currentRoute.value.query.traceId),t.currentRoute.value.query.serviceName&&t.currentRoute.value.query.traceId&&k(),window.addEventListener("resize",R),E=new ResizeObserver(()=>R),E.observe(document.getElementById("trace-topology-div"))}),re(()=>{window.removeEventListener("resize",R),E.disconnect()});const S=b(0),z=async()=>{f.value.splice(0,f.value.length),N.splice(0,N.length),S.value=0,d&&d.dispose(),g.value=[],m.value="",c.serviceName=o.value[1];const l=await ce(c);l!==null&&(S.value=l.result.length,l.result.forEach(e=>{f.value.push(e)}),f.value.forEach(e=>{N.push(e.endPoint)}),g.value=f.value[0].traceIds)};let g=b([]);const f=b([{endPoint:{},traceIds:[]}]),N=q([]),A=async l=>{c.pageSize=l,await z()},O=async l=>{c.pageNum=l,await z()},T=l=>{f.value.forEach(e=>{e.endPoint===l&&(g.value=e.traceIds)})},m=b(),P=b({name:"",value:"",collapsed:!1,children:[]}),$=async()=>{if(m.value===""||m.value===void 0)return;const l=await de(m.value,o.value[1]);l!==null&&(P.value=l.result,k())};let d;const _=Y("theme-appearance","auto");oe(_,()=>{k()});const k=()=>{d&&d.dispose();let l={title:{subtext:"\u7EFF\u8272\u4E3A\u6B63\u5E38\u8282\u70B9\uFF0C\u7EA2\u8272\u4E3A\u5F02\u5E38\u8282\u70B9",align:"right"},backgroundColor:_.value==="dark"?"#212224":"#fff",tooltip:{trigger:"item",triggerOn:"mousemove",backgroundColor:_.value==="dark"?"#212224":"#fff",textStyle:{color:_.value==="dark"?"#fff":"#212224"}},series:[{type:"tree",symbol:"circle",roam:!0,expandAndCollapse:!0,animationDuration:550,animationDurationUpdate:750,label:{position:"right",verticalAlign:"middle",fontSize:9},initialTreeDepth:-1,data:[P.value]}]};d=ee(document.getElementById("trace-topology-div"),_.value==="dark"?"dark":"light"),d.setOption(l)};return(l,e)=>{const y=r("el-breadcrumb-item"),I=r("el-breadcrumb"),p=r("el-row"),i=r("el-cascader"),B=r("el-divider"),w=r("el-table-column"),L=r("ArrowRightBold"),F=r("el-icon"),M=r("el-button"),Z=r("el-tooltip"),j=r("el-table"),G=r("el-pagination"),V=r("el-col"),H=r("el-option"),J=r("el-select"),K=r("el-form-item"),Q=r("el-card");return C(),D("div",pe,[a(p,null,{default:u(()=>[a(I,{"separator-icon":"ArrowRight"},{default:u(()=>[a(y,null,{default:u(()=>e[4]||(e[4]=[s("a",{href:"/main"},"\u4E3B\u9875",-1)])),_:1}),a(y,null,{default:u(()=>e[5]||(e[5]=[s("a",{href:"/main/trace"},"\u94FE\u8DEF\u4FE1\u606F",-1)])),_:1})]),_:1})]),_:1}),a(Q,{class:"table-card"},{default:u(()=>[s("div",me,[a(i,{placeholder:"\u8BF7\u9009\u62E9\u5BF9\u5E94\u670D\u52A1",modelValue:o.value,"onUpdate:modelValue":e[0]||(e[0]=n=>o.value=n),style:{width:"40%"},clearable:"",props:U,"show-all-levels":!1,onChange:z},null,8,["modelValue","props"])]),a(B),a(p,{gutter:10,style:{"margin-top":"2%"}},{default:u(()=>[a(V,{span:8},{default:u(()=>[e[6]||(e[6]=s("div",null,"\u8FFD\u8E2A\u7AEF\u70B9\u4FE1\u606F",-1)),s("div",ve,[s("div",ge,[a(j,{data:N,stripe:""},{default:u(()=>[a(w,{prop:"serviceName",label:"\u670D\u52A1\u540D\u79F0"}),a(w,{prop:"ip",label:"IP\u5730\u5740"}),a(w,{prop:"port",label:"\u7AEF\u53E3\u53F7"}),a(w,{prop:"latency",label:"\u65F6\u5EF6"}),a(w,{fixed:"right",label:"\u7ED8\u56FE"},{default:u(n=>[a(Z,{effect:"light",content:"\u67E5\u770BEndpoint\u6240\u5728\u94FE\u8DEF\u4FE1\u606F",placement:"top",enterable:!1},{default:u(()=>[a(M,{type:"primary",circle:"",size:"small",onClick:be=>T(n.row)},{default:u(()=>[a(F,null,{default:u(()=>[a(L)]),_:1})]),_:2},1032,["onClick"])]),_:2},1024)]),_:1})]),_:1},8,["data"])]),s("div",fe,[a(G,{"current-page":c.pageNum,"onUpdate:currentPage":e[1]||(e[1]=n=>c.pageNum=n),"page-size":c.pageSize,"onUpdate:pageSize":e[2]||(e[2]=n=>c.pageSize=n),"page-sizes":[2,5,10,20],layout:"total, pager, sizes",total:S.value,"pager-count":5,onSizeChange:A,onCurrentChange:O},null,8,["current-page","page-size","total"])])])]),_:1}),a(V,{span:16},{default:u(()=>[s("div",null,[e[7]||(e[7]=s("div",null,"Span\u8C03\u7528\u56FE",-1)),a(K,{label:"TraceId"},{default:u(()=>[a(J,{modelValue:m.value,"onUpdate:modelValue":e[3]||(e[3]=n=>m.value=n),placeholder:"\u8BF7\u5728\u5DE6\u4FA7\u9009\u62E9Endpoint\u540E\uFF0C\u9009\u62E9TraceId",style:{width:"40%"},clearable:"",onChange:$},{default:u(()=>[(C(!0),D(ue,null,ne(ie(g),n=>(C(),se(H,{key:n,label:n,value:n},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),e[8]||(e[8]=s("div",{id:"trace-topology-div"},null,-1))]),_:1})]),_:1})]),_:1})])}}},he=le(ye,[["__scopeId","data-v-86278f70"]]);export{he as default};
